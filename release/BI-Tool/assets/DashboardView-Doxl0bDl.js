import{u as X}from"./dataStore-B12QgO0T.js";import{i as N,j,k as P,x as O,C as G,y as Y,c as r,o as i,a as e,s as h,l as k,B as E,E as H,m as T,v as $,t as g,F as S,q as M,d as q,D as J,b as W,w as Z,r as K,G as I}from"./vendor-vue-KVDUZo9Z.js";import{i as Q}from"./vendor-echarts-Bb6yjXMn.js";import{g as ee}from"./chartGenerator-CAZcMGj7.js";const te={class:"bg-white rounded-lg shadow-md overflow-hidden"},oe={class:"bg-gray-50 border-b px-4 py-2 flex items-center justify-between"},se={class:"flex items-center space-x-2"},le=["title"],ne={class:"border-b bg-gray-50 p-3"},ae={class:"grid grid-cols-2 md:grid-cols-4 gap-3"},ie={class:"block text-xs font-medium text-gray-600 mb-1"},re=["value"],ue={class:"block text-xs font-medium text-gray-600 mb-1"},de=["value"],ce={key:0},ve={key:1},pe=["value"],me={key:2},xe={key:0,class:"bg-yellow-50 border-b border-yellow-200 px-3 py-2 text-sm text-yellow-700"},ge={class:"p-2 relative"},ye={key:0,class:"h-64 flex items-center justify-center text-gray-400"},be={key:1,class:"relative"},fe={key:0,class:"absolute inset-0 bg-white bg-opacity-80 flex items-center justify-center z-10"},he={__name:"DashboardChartPanel",props:{panel:{type:Object,required:!0},columns:{type:Array,required:!0},data:{type:Array,required:!0}},emits:["update","remove","chart-ready"],setup(V,{emit:D}){const c=V,b=D,t=N({...c.panel}),w=N(null);let v=null,y=null;const C=N(!1),z=j(()=>c.columns.filter(a=>a!==t.value.xAxis)),f=j(()=>{if(!t.value.groupBy||!c.data.length)return"";const s=new Set(c.data.map(o=>o[t.value.groupBy])).size;return s>50?`グループ数が ${s} 件と非常に多いです。処理に時間がかかる場合があります。`:s>20?`グループ数が ${s} 件あります。表示が複雑になる可能性があります。`:""});P(()=>c.panel,a=>{t.value={...a}},{deep:!0});function R(){t.value.showSettings=!t.value.showSettings,B()}function B(){b("update",{...t.value})}function A(){if(!w.value)return;if(!t.value.xAxis||!t.value.yAxis){v&&(v.dispose(),v=null);return}if(!c.data||c.data.length===0)return;v||(v=Q(w.value),b("chart-ready",{panelId:c.panel.id,instance:v}));const a={xAxis:t.value.xAxis,yAxis:t.value.yAxis,category:t.value.xAxis,value:t.value.yAxis,title:t.value.title,aggregation:t.value.aggregation||"sum",groupBy:t.value.groupBy||"",stackMode:t.value.stackMode||"none",sortBy:"none",enableZoom:!1};try{const s=ee(t.value.type,a,c.data);v.setOption(s,!0)}catch(s){console.error("Chart generation error:",s)}}function L(){y&&clearTimeout(y),C.value=!0,y=setTimeout(()=>{G(()=>{A(),C.value=!1}),y=null},150)}function x(){if(!v)return;const a=v.getDataURL({type:"png",pixelRatio:2,backgroundColor:"#fff"}),s=document.createElement("a");s.href=a,s.download=`${t.value.title||"chart"}_${Date.now()}.png`,s.click()}function n(){v==null||v.resize()}return P(()=>[t.value.type,t.value.xAxis,t.value.yAxis,t.value.aggregation,t.value.groupBy,t.value.stackMode],()=>{L()}),P(()=>c.data,()=>{L()},{deep:!0}),O(()=>{window.addEventListener("resize",n),G(()=>{t.value.xAxis&&t.value.yAxis&&A()})}),Y(()=>{window.removeEventListener("resize",n),y&&clearTimeout(y),v&&(v.dispose(),v=null)}),(a,s)=>(i(),r("div",te,[e("div",oe,[h(e("input",{"onUpdate:modelValue":s[0]||(s[0]=o=>t.value.title=o),type:"text",class:"bg-transparent border-none font-medium text-gray-800 focus:outline-none focus:ring-1 focus:ring-primary-500 rounded px-1",onBlur:B},null,544),[[E,t.value.title]]),e("div",se,[e("button",{onClick:R,class:"p-1 text-gray-500 hover:text-primary-600 transition-colors",title:t.value.showSettings?"設定を閉じる":"設定を開く"},[...s[8]||(s[8]=[e("svg",{class:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"}),e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M15 12a3 3 0 11-6 0 3 3 0 016 0z"})],-1)])],8,le),e("button",{onClick:x,class:"p-1 text-gray-500 hover:text-green-600 transition-colors",title:"PNG出力"},[...s[9]||(s[9]=[e("svg",{class:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"})],-1)])]),e("button",{onClick:s[1]||(s[1]=o=>a.$emit("remove",V.panel.id)),class:"p-1 text-gray-500 hover:text-red-600 transition-colors",title:"削除"},[...s[10]||(s[10]=[e("svg",{class:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M6 18L18 6M6 6l12 12"})],-1)])])])]),h(e("div",ne,[e("div",ae,[e("div",null,[s[12]||(s[12]=e("label",{class:"block text-xs font-medium text-gray-600 mb-1"},"種別",-1)),h(e("select",{"onUpdate:modelValue":s[2]||(s[2]=o=>t.value.type=o),onChange:B,class:"select-box text-sm"},[...s[11]||(s[11]=[T('<option value="bar">棒グラフ</option><option value="line">折れ線</option><option value="pie">円グラフ</option><option value="scatter">散布図</option><option value="area">面グラフ</option>',5)])],544),[[$,t.value.type]])]),e("div",null,[e("label",ie,g(t.value.type==="pie"?"カテゴリ":"X軸"),1),h(e("select",{"onUpdate:modelValue":s[3]||(s[3]=o=>t.value.xAxis=o),onChange:B,class:"select-box text-sm"},[s[13]||(s[13]=e("option",{value:""},"選択",-1)),(i(!0),r(S,null,M(V.columns,o=>(i(),r("option",{key:o,value:o},g(o),9,re))),128))],544),[[$,t.value.xAxis]])]),e("div",null,[e("label",ue,g(t.value.type==="pie"?"値":"Y軸"),1),h(e("select",{"onUpdate:modelValue":s[4]||(s[4]=o=>t.value.yAxis=o),onChange:B,class:"select-box text-sm"},[s[14]||(s[14]=e("option",{value:""},"選択",-1)),(i(!0),r(S,null,M(V.columns,o=>(i(),r("option",{key:o,value:o},g(o),9,de))),128))],544),[[$,t.value.yAxis]])]),t.value.type!=="scatter"?(i(),r("div",ce,[s[16]||(s[16]=e("label",{class:"block text-xs font-medium text-gray-600 mb-1"},"集計",-1)),h(e("select",{"onUpdate:modelValue":s[5]||(s[5]=o=>t.value.aggregation=o),onChange:B,class:"select-box text-sm"},[...s[15]||(s[15]=[T('<option value="sum">合計</option><option value="count">カウント</option><option value="avg">平均</option><option value="max">最大</option><option value="min">最小</option>',5)])],544),[[$,t.value.aggregation]])])):k("",!0),["bar","line","area"].includes(t.value.type)?(i(),r("div",ve,[s[18]||(s[18]=e("label",{class:"block text-xs font-medium text-gray-600 mb-1"},"グループ化",-1)),h(e("select",{"onUpdate:modelValue":s[6]||(s[6]=o=>t.value.groupBy=o),onChange:B,class:"select-box text-sm"},[s[17]||(s[17]=e("option",{value:""},"なし",-1)),(i(!0),r(S,null,M(z.value,o=>(i(),r("option",{key:o,value:o},g(o),9,pe))),128))],544),[[$,t.value.groupBy]])])):k("",!0),t.value.type==="bar"&&t.value.groupBy?(i(),r("div",me,[s[20]||(s[20]=e("label",{class:"block text-xs font-medium text-gray-600 mb-1"},"表示モード",-1)),h(e("select",{"onUpdate:modelValue":s[7]||(s[7]=o=>t.value.stackMode=o),onChange:B,class:"select-box text-sm"},[...s[19]||(s[19]=[e("option",{value:"none"},"並列",-1),e("option",{value:"stacked"},"積み上げ",-1),e("option",{value:"percent"},"100%積上",-1)])],544),[[$,t.value.stackMode]])])):k("",!0)])],512),[[H,t.value.showSettings]]),f.value?(i(),r("div",xe,[s[21]||(s[21]=e("svg",{class:"w-4 h-4 inline mr-1",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"})],-1)),q(" "+g(f.value),1)])):k("",!0),e("div",ge,[!t.value.xAxis||!t.value.yAxis?(i(),r("div",ye,[...s[22]||(s[22]=[e("div",{class:"text-center"},[e("svg",{class:"w-12 h-12 mx-auto mb-2",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"})]),e("p",{class:"text-sm"},"X軸とY軸を選択してください")],-1)])])):(i(),r("div",be,[C.value?(i(),r("div",fe,[...s[23]||(s[23]=[T('<div class="text-center"><svg class="animate-spin w-8 h-8 mx-auto mb-2 text-primary-600" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg><p class="text-sm text-gray-600">チャート作成中...</p></div>',1)])])):k("",!0),e("div",{ref_key:"chartContainer",ref:w,class:"h-64 w-full"},null,512)]))])]))}},ke={class:"bg-white rounded-lg shadow-md overflow-hidden"},we={class:"bg-gray-50 border-b px-4 py-2 flex items-center justify-between"},Ce={class:"flex items-center space-x-2"},Be=["title"],_e={class:"border-b bg-gray-50 p-3"},$e={class:"grid grid-cols-2 md:grid-cols-4 gap-3"},Ae=["value"],Ve=["value"],Se={class:"mt-3"},Me={key:0,class:"text-xs text-gray-400 text-center py-1 border border-dashed rounded"},Ue={key:1,class:"space-y-1"},je=["onUpdate:modelValue"],De=["value"],ze=["onUpdate:modelValue"],Le=["onUpdate:modelValue"],Ne=["onClick"],Re={class:"p-2"},Fe={key:0,class:"h-64 flex items-center justify-center text-gray-400"},Pe={key:1,class:"overflow-x-auto max-h-72 overflow-y-auto"},Te={class:"w-full text-xs"},qe={class:"sticky top-0 bg-gray-50"},Ee={class:"border-b"},Ge={class:"px-2 py-1.5 text-left font-medium text-gray-700"},Ie={key:0,class:"px-2 py-1.5 text-right font-medium text-gray-700"},Oe={key:1,class:"px-2 py-1.5 text-right font-medium text-gray-700"},He={class:"px-2 py-1.5 text-gray-800"},Xe={class:"px-2 py-1.5 text-right text-gray-600"},Ye={key:0,class:"px-2 py-1.5 text-right text-gray-600"},Je={key:1,class:"px-2 py-1.5 text-right text-gray-600"},We={class:"px-2 py-1.5 text-right"},Ze={class:"flex items-center justify-end"},Ke={class:"w-12 bg-gray-200 rounded-full h-1.5 mr-1"},Qe={class:"text-gray-600 w-10 text-right"},et={key:0,class:"bg-gray-100 font-medium sticky bottom-0"},tt={class:"px-2 py-1.5 text-right text-gray-800"},ot={key:0,class:"px-2 py-1.5 text-right text-gray-800"},st={key:1,class:"px-2 py-1.5 text-right text-gray-800"},lt={__name:"DashboardTablePanel",props:{panel:{type:Object,required:!0},columns:{type:Array,required:!0},data:{type:Array,required:!0}},emits:["update","remove"],setup(V,{emit:D}){const c=V,b=D,t=N({...c.panel});P(()=>c.panel,x=>{t.value={...x}},{deep:!0});const w=j(()=>{var n;if(!((n=c.data)!=null&&n.length))return[];const x=c.data[0];return c.columns.filter(a=>{const s=x[a];return typeof s=="number"||!isNaN(parseFloat(s))})}),v=j(()=>{var x;return c.data.length?(x=t.value.filters)!=null&&x.length?c.data.filter(n=>t.value.filters.every(a=>{if(!a.column)return!0;const s=n[a.column],o=a.value;switch(a.operator){case"eq":return String(s)===String(o);case"ne":return String(s)!==String(o);case"contains":return String(s).toLowerCase().includes(String(o).toLowerCase());case"gt":return Number(s)>Number(o);case"lt":return Number(s)<Number(o);default:return!0}})):c.data:[]}),y=j(()=>{if(!t.value.groupBy||!v.value.length)return[];const x=new Map;v.value.forEach(d=>{const p=String(d[t.value.groupBy]??"(空白)");x.has(p)||x.set(p,[]),x.get(p).push(d)});const n=v.value.length,a=t.value.valueColumn,s=Array.from(x.entries()).map(([d,p])=>{const m=p.length;let _=0;return a&&p.forEach(U=>{const F=parseFloat(U[a])||0;_+=F}),{label:d,count:m,sum:a?_:0,avg:a&&m>0?_/m:0,percent:n>0?m/n*100:0}}),o={label_asc:(d,p)=>d.label.localeCompare(p.label),label_desc:(d,p)=>p.label.localeCompare(d.label),count_desc:(d,p)=>p.count-d.count,count_asc:(d,p)=>d.count-p.count,sum_desc:(d,p)=>p.sum-d.sum,sum_asc:(d,p)=>d.sum-p.sum},l=s.sort(o[t.value.sortBy]||o.count_desc),u=t.value.limit||0;return u>0?l.slice(0,u):l}),C=j(()=>{if(!y.value.length)return null;const x=y.value.reduce((a,s)=>a+s.count,0),n=y.value.reduce((a,s)=>a+s.sum,0);return{count:x,sum:n,avg:x>0?n/x:0}});function z(){t.value.showSettings=!t.value.showSettings,f()}function f(){b("update",{...t.value})}function R(){t.value.filters||(t.value.filters=[]),t.value.filters.push({column:"",operator:"eq",value:""}),f()}function B(x){t.value.filters.splice(x,1),f()}function A(x,n=0){return x==null?"-":Number(x).toLocaleString("ja-JP",{minimumFractionDigits:n,maximumFractionDigits:n})}function L(){if(!y.value.length)return;const x=[t.value.groupBy,"カウント"];t.value.valueColumn&&x.push("合計","平均"),x.push("割合(%)");const n=y.value.map(u=>{const d=[u.label,u.count];return t.value.valueColumn&&d.push(u.sum,u.avg.toFixed(2)),d.push(u.percent.toFixed(1)),d.join(",")}),a=[x.join(","),...n].join(`
`),s=new Blob(["\uFEFF"+a],{type:"text/csv;charset=utf-8"}),o=URL.createObjectURL(s),l=document.createElement("a");l.href=o,l.download=`${t.value.title||"table"}_${Date.now()}.csv`,l.click(),URL.revokeObjectURL(o)}return(x,n)=>(i(),r("div",ke,[e("div",we,[h(e("input",{"onUpdate:modelValue":n[0]||(n[0]=a=>t.value.title=a),type:"text",class:"bg-transparent border-none font-medium text-gray-800 focus:outline-none focus:ring-1 focus:ring-primary-500 rounded px-1",onBlur:f},null,544),[[E,t.value.title]]),e("div",Ce,[e("button",{onClick:z,class:"p-1 text-gray-500 hover:text-primary-600 transition-colors",title:t.value.showSettings?"設定を閉じる":"設定を開く"},[...n[6]||(n[6]=[e("svg",{class:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"}),e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M15 12a3 3 0 11-6 0 3 3 0 016 0z"})],-1)])],8,Be),e("button",{onClick:L,class:"p-1 text-gray-500 hover:text-green-600 transition-colors",title:"CSV出力"},[...n[7]||(n[7]=[e("svg",{class:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"})],-1)])]),e("button",{onClick:n[1]||(n[1]=a=>x.$emit("remove",V.panel.id)),class:"p-1 text-gray-500 hover:text-red-600 transition-colors",title:"削除"},[...n[8]||(n[8]=[e("svg",{class:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M6 18L18 6M6 6l12 12"})],-1)])])])]),h(e("div",_e,[e("div",$e,[e("div",null,[n[10]||(n[10]=e("label",{class:"block text-xs font-medium text-gray-600 mb-1"},"グループ化",-1)),h(e("select",{"onUpdate:modelValue":n[2]||(n[2]=a=>t.value.groupBy=a),onChange:f,class:"select-box text-sm"},[n[9]||(n[9]=e("option",{value:""},"選択",-1)),(i(!0),r(S,null,M(V.columns,a=>(i(),r("option",{key:a,value:a},g(a),9,Ae))),128))],544),[[$,t.value.groupBy]])]),e("div",null,[n[12]||(n[12]=e("label",{class:"block text-xs font-medium text-gray-600 mb-1"},"集計対象",-1)),h(e("select",{"onUpdate:modelValue":n[3]||(n[3]=a=>t.value.valueColumn=a),onChange:f,class:"select-box text-sm"},[n[11]||(n[11]=e("option",{value:""},"選択",-1)),(i(!0),r(S,null,M(w.value,a=>(i(),r("option",{key:a,value:a},g(a),9,Ve))),128))],544),[[$,t.value.valueColumn]])]),e("div",null,[n[14]||(n[14]=e("label",{class:"block text-xs font-medium text-gray-600 mb-1"},"並び順",-1)),h(e("select",{"onUpdate:modelValue":n[4]||(n[4]=a=>t.value.sortBy=a),onChange:f,class:"select-box text-sm"},[...n[13]||(n[13]=[T('<option value="count_desc">カウント降順</option><option value="count_asc">カウント昇順</option><option value="sum_desc">合計降順</option><option value="sum_asc">合計昇順</option><option value="label_asc">ラベル昇順</option><option value="label_desc">ラベル降順</option>',6)])],544),[[$,t.value.sortBy]])]),e("div",null,[n[16]||(n[16]=e("label",{class:"block text-xs font-medium text-gray-600 mb-1"},"表示上限",-1)),h(e("select",{"onUpdate:modelValue":n[5]||(n[5]=a=>t.value.limit=a),onChange:f,class:"select-box text-sm"},[...n[15]||(n[15]=[e("option",{value:10},"10件",-1),e("option",{value:20},"20件",-1),e("option",{value:50},"50件",-1),e("option",{value:100},"100件",-1),e("option",{value:0},"全件",-1)])],544),[[$,t.value.limit,void 0,{number:!0}]])])]),e("div",Se,[e("div",{class:"flex items-center justify-between mb-2"},[n[17]||(n[17]=e("label",{class:"text-xs font-medium text-gray-600"},"フィルター",-1)),e("button",{onClick:R,class:"text-xs text-primary-600 hover:text-primary-800"}," + 追加 ")]),t.value.filters.length===0?(i(),r("div",Me," フィルターなし ")):(i(),r("div",Ue,[(i(!0),r(S,null,M(t.value.filters,(a,s)=>(i(),r("div",{key:s,class:"flex items-center gap-1 text-xs"},[h(e("select",{"onUpdate:modelValue":o=>a.column=o,onChange:f,class:"select-box text-xs flex-1"},[n[18]||(n[18]=e("option",{value:""},"カラム",-1)),(i(!0),r(S,null,M(V.columns,o=>(i(),r("option",{key:o,value:o},g(o),9,De))),128))],40,je),[[$,a.column]]),h(e("select",{"onUpdate:modelValue":o=>a.operator=o,onChange:f,class:"select-box text-xs w-16"},[...n[19]||(n[19]=[T('<option value="eq">=</option><option value="ne">≠</option><option value="contains">含</option><option value="gt">&gt;</option><option value="lt">&lt;</option>',5)])],40,ze),[[$,a.operator]]),h(e("input",{"onUpdate:modelValue":o=>a.value=o,onChange:f,type:"text",class:"input-field text-xs flex-1",placeholder:"値"},null,40,Le),[[E,a.value]]),e("button",{onClick:o=>B(s),class:"text-red-400 hover:text-red-600"},[...n[20]||(n[20]=[e("svg",{class:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M6 18L18 6M6 6l12 12"})],-1)])],8,Ne)]))),128))]))])],512),[[H,t.value.showSettings]]),e("div",Re,[t.value.groupBy?(i(),r("div",Pe,[e("table",Te,[e("thead",qe,[e("tr",Ee,[e("th",Ge,g(t.value.groupBy),1),n[22]||(n[22]=e("th",{class:"px-2 py-1.5 text-right font-medium text-gray-700"},"カウント",-1)),t.value.valueColumn?(i(),r("th",Ie,"合計")):k("",!0),t.value.valueColumn?(i(),r("th",Oe,"平均")):k("",!0),n[23]||(n[23]=e("th",{class:"px-2 py-1.5 text-right font-medium text-gray-700"},"割合",-1))])]),e("tbody",null,[(i(!0),r(S,null,M(y.value,(a,s)=>(i(),r("tr",{key:s,class:"border-b hover:bg-gray-50 transition-colors"},[e("td",He,g(a.label),1),e("td",Xe,g(A(a.count)),1),t.value.valueColumn?(i(),r("td",Ye,g(A(a.sum)),1)):k("",!0),t.value.valueColumn?(i(),r("td",Je,g(A(a.avg,2)),1)):k("",!0),e("td",We,[e("div",Ze,[e("div",Ke,[e("div",{class:"bg-primary-500 h-1.5 rounded-full",style:J({width:a.percent+"%"})},null,4)]),e("span",Qe,g(a.percent.toFixed(1))+"%",1)])])]))),128))]),C.value?(i(),r("tfoot",et,[e("tr",null,[n[24]||(n[24]=e("td",{class:"px-2 py-1.5 text-gray-800"},"合計",-1)),e("td",tt,g(A(C.value.count)),1),t.value.valueColumn?(i(),r("td",ot,g(A(C.value.sum)),1)):k("",!0),t.value.valueColumn?(i(),r("td",st,g(A(C.value.avg,2)),1)):k("",!0),n[25]||(n[25]=e("td",{class:"px-2 py-1.5 text-right text-gray-800"},"100%",-1))])])):k("",!0)])])):(i(),r("div",Fe,[...n[21]||(n[21]=[e("div",{class:"text-center"},[e("svg",{class:"w-12 h-12 mx-auto mb-2",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"})]),e("p",{class:"text-sm"},"グループ化カラムを選択してください")],-1)])]))])]))}},nt={class:"space-y-4"},at={class:"bg-white rounded-lg shadow-md p-4 flex items-center justify-between"},it={class:"text-sm text-gray-500"},rt={key:0,class:"text-primary-600"},ut={class:"flex space-x-2"},dt=["disabled"],ct=["disabled"],vt=["disabled"],pt=["disabled"],mt={key:0,class:"bg-yellow-50 border border-yellow-200 rounded-lg p-4 text-center"},xt={class:"text-yellow-700"},gt={key:1,class:"grid grid-cols-1 lg:grid-cols-2 gap-4"},yt={key:0,class:"lg:col-span-2 bg-gray-50 border-2 border-dashed border-gray-300 rounded-lg p-8 text-center"},wt={__name:"DashboardView",setup(V){const D=X(),c=N([]),b=N([]);let t=0;const w=new Map,v=j(()=>D.activeDataset),y=j(()=>{var o;return((o=v.value)==null?void 0:o.columns)||[]}),C=j(()=>{var o;return((o=v.value)==null?void 0:o.data)||[]});function z(){if(!v.value)return;const o=y.value,l=o[0]||"",u=o.length>1?o[1]:o[0]||"",d=v.value.name||"データ",p={id:++t,title:`${d}_${u}×${l}`,type:"bar",xAxis:l,yAxis:u,aggregation:"sum",groupBy:"",stackMode:"none",showSettings:!0};c.value.push(p)}function f(){if(!v.value)return;const o=y.value,l=o[0]||"",u=o.length>1?o[1]:"",d=v.value.name||"データ",p={id:++t,title:`${d}_${l}集計`,groupBy:l,valueColumn:u,sortBy:"count_desc",limit:20,filters:[],showSettings:!0};b.value.push(p)}function R(o){const l=c.value.findIndex(u=>u.id===o.id);l!==-1&&(c.value[l]={...o})}function B(o){const l=c.value.findIndex(u=>u.id===o);if(l!==-1){const u=w.get(o);u&&(u.dispose(),w.delete(o)),c.value.splice(l,1)}}function A(o){const l=b.value.findIndex(u=>u.id===o.id);l!==-1&&(b.value[l]={...o})}function L(o){const l=b.value.findIndex(u=>u.id===o);l!==-1&&b.value.splice(l,1)}function x({panelId:o,instance:l}){w.set(o,l)}function n(){c.value.forEach(o=>{const l=w.get(o.id);if(l){const u=l.getDataURL({type:"png",pixelRatio:2,backgroundColor:"#fff"}),d=document.createElement("a");d.href=u,d.download=`${o.title||"chart"}_${Date.now()}.png`,d.click()}})}function a(){const o={charts:c.value.map(l=>({id:l.id,title:l.title,type:l.type,xAxis:l.xAxis,yAxis:l.yAxis,aggregation:l.aggregation,groupBy:l.groupBy,stackMode:l.stackMode})),tables:b.value.map(l=>({id:l.id,title:l.title,groupBy:l.groupBy,valueColumn:l.valueColumn,sortBy:l.sortBy,limit:l.limit,filters:l.filters||[]}))};localStorage.setItem("bi-dashboard",JSON.stringify(o)),alert("ダッシュボードを保存しました")}function s(){const o=localStorage.getItem("bi-dashboard");if(!(!o||!v.value))try{const l=JSON.parse(o),u=y.value;if(Array.isArray(l)){const p=l.map(m=>{const _=u.includes(m.xAxis)?m.xAxis:"",U=u.includes(m.yAxis)?m.yAxis:"",F=m.groupBy&&u.includes(m.groupBy)?m.groupBy:"";return{...m,xAxis:_,yAxis:U,groupBy:F,showSettings:!_||!U}});c.value=p,b.value=[],t=Math.max(...l.map(m=>m.id),0);return}if(l.charts){const p=l.charts.map(m=>{const _=u.includes(m.xAxis)?m.xAxis:"",U=u.includes(m.yAxis)?m.yAxis:"",F=m.groupBy&&u.includes(m.groupBy)?m.groupBy:"";return{...m,xAxis:_,yAxis:U,groupBy:F,showSettings:!_||!U}});c.value=p}if(l.tables){const p=l.tables.map(m=>{const _=u.includes(m.groupBy)?m.groupBy:"",U=m.valueColumn&&u.includes(m.valueColumn)?m.valueColumn:"";return{...m,groupBy:_,valueColumn:U,filters:m.filters||[],showSettings:!_}});b.value=p}const d=[...(l.charts||[]).map(p=>p.id),...(l.tables||[]).map(p=>p.id)];t=Math.max(...d,0)}catch(l){console.error("Failed to load dashboard:",l)}}return P(()=>D.activeDatasetId,o=>{o&&(w.forEach(l=>l==null?void 0:l.dispose()),w.clear(),c.value=[],b.value=[],setTimeout(()=>s(),100))},{immediate:!0}),O(()=>{v.value&&s()}),(o,l)=>{const u=K("router-link");return i(),r("div",nt,[e("div",at,[e("div",null,[l[1]||(l[1]=e("h2",{class:"text-xl font-semibold text-gray-800"},"ダッシュボード",-1)),e("p",it,[l[0]||(l[0]=q(" 複数のチャートを配置して分析 ",-1)),v.value?(i(),r("span",rt," （"+g(v.value.name)+" - "+g(C.value.length)+"行） ",1)):k("",!0)])]),e("div",ut,[e("button",{onClick:z,class:"btn-primary text-sm",disabled:!v.value}," + チャート ",8,dt),e("button",{onClick:f,class:"btn-secondary text-sm",disabled:!v.value}," + 表分析 ",8,ct),e("button",{onClick:n,class:"btn-secondary text-sm",disabled:c.value.length===0}," PNG出力 ",8,vt),e("button",{onClick:a,class:"btn-accent text-sm",disabled:c.value.length===0&&b.value.length===0}," 保存 ",8,pt)])]),v.value?(i(),r("div",gt,[(i(!0),r(S,null,M(c.value,d=>(i(),I(he,{key:"chart-"+d.id,panel:d,columns:y.value,data:C.value,onUpdate:R,onRemove:B,onChartReady:x},null,8,["panel","columns","data"]))),128)),(i(!0),r(S,null,M(b.value,d=>(i(),I(lt,{key:"table-"+d.id,panel:d,columns:y.value,data:C.value,onUpdate:A,onRemove:L},null,8,["panel","columns","data"]))),128)),c.value.length===0&&b.value.length===0?(i(),r("div",yt,[l[4]||(l[4]=e("svg",{class:"w-16 h-16 mx-auto text-gray-300 mb-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"})],-1)),l[5]||(l[5]=e("p",{class:"text-gray-500 mb-4"},"パネルがありません",-1)),e("div",{class:"space-x-2"},[e("button",{onClick:z,class:"btn-primary"},"チャート追加"),e("button",{onClick:f,class:"btn-secondary"},"表分析追加")])])):k("",!0)])):(i(),r("div",mt,[e("p",xt,[l[3]||(l[3]=q(" まずデータをアップロードしてください。 ",-1)),W(u,{to:"/",class:"text-primary-500 hover:underline"},{default:Z(()=>[...l[2]||(l[2]=[q("ホームに戻る",-1)])]),_:1})])]))])}}};export{wt as default};
